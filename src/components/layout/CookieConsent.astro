---
// Cookie Consent Banner mit PostHog Integration
// DSGVO-konform mit gleichwertigen Buttons
// Mit Ursula von der Leyen als EU-Datenschutz-Gimmick
---

<div id="cookie-consent" class="fixed bottom-0 left-0 right-0 z-50 hidden">
    <div class="bg-white border-t border-gray-200 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-5 sm:px-6 lg:px-8">
            <div
                class="flex flex-col sm:flex-row items-center sm:items-start gap-4"
            >
                <!-- Ursula Bild -->
                <img
                    src="/assets/ursula.png"
                    alt="EU Datenschutz"
                    class="w-16 h-16 rounded-full object-cover flex-shrink-0 border-2 border-gray-100 shadow-sm"
                />

                <!-- Content -->
                <div class="flex-1 text-center sm:text-left">
                    <h3 class="font-semibold text-gray-800 mb-1 text-base">
                        Ihre Daten, Ihre Entscheidung
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Wir nutzen Cookies für anonyme Nutzungsanalysen, um
                        unsere Website zu verbessern.
                        <a
                            href="/datenschutz/"
                            class="text-teal hover:text-teal-light underline"
                        >
                            Mehr erfahren
                        </a>
                    </p>

                    <!-- Buttons: Mobile gestapelt, Desktop nebeneinander -->
                    <div
                        class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto"
                    >
                        <button
                            id="cookie-decline"
                            class="w-full sm:w-auto bg-teal text-white px-6 py-2.5 rounded-lg text-sm font-medium hover:bg-teal-light transition-colors"
                        >
                            Ablehnen
                        </button>
                        <button
                            id="cookie-accept"
                            class="w-full sm:w-auto bg-teal text-white px-6 py-2.5 rounded-lg text-sm font-medium hover:bg-teal-light transition-colors"
                        >
                            Akzeptieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script is:inline>
    (function () {
        const CONSENT_KEY = "analytics-consent";
        const POSTHOG_KEY = "phc_aJvCWzlGIVwg0jBIQzbfj4sPnxeCr4GrQADIwhYcQtD";
        const POSTHOG_HOST = "https://eu.i.posthog.com";

        function loadPostHog() {
            if (window.posthog) return;

            !(function (t, e) {
                var o, n, p, r;
                e.__SV ||
                    ((window.posthog = e),
                    (e._i = []),
                    (e.init = function (i, s, a) {
                        function g(t, e) {
                            var o = e.split(".");
                            (2 == o.length && ((t = t[o[0]]), (e = o[1])),
                                (t[e] = function () {
                                    t.push(
                                        [e].concat(
                                            Array.prototype.slice.call(
                                                arguments,
                                                0,
                                            ),
                                        ),
                                    );
                                }));
                        }
                        (((p = t.createElement("script")).type =
                            "text/javascript"),
                            (p.crossOrigin = "anonymous"),
                            (p.async = !0),
                            (p.src =
                                s.api_host.replace(
                                    ".i.posthog.com",
                                    "-assets.i.posthog.com",
                                ) + "/static/array.js"),
                            (r =
                                t.getElementsByTagName(
                                    "script",
                                )[0]).parentNode.insertBefore(p, r));
                        var u = e;
                        for (
                            void 0 !== a ? (u = e[a] = []) : (a = "posthog"),
                                u.people = u.people || [],
                                u.toString = function (t) {
                                    var e = "posthog";
                                    return (
                                        "posthog" !== a && (e += "." + a),
                                        t || (e += " (stub)"),
                                        e
                                    );
                                },
                                u.people.toString = function () {
                                    return u.toString(1) + ".people (stub)";
                                },
                                o =
                                    "init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(
                                        " ",
                                    ),
                                n = 0;
                            n < o.length;
                            n++
                        )
                            g(u, o[n]);
                        e._i.push([i, s, a]);
                    }),
                    (e.__SV = 1));
            })(document, window.posthog || []);

            posthog.init(POSTHOG_KEY, {
                api_host: POSTHOG_HOST,
                capture_pageview: true,
                capture_pageleave: true,
                persistence: "localStorage+cookie",
                autocapture: true,
                session_recording: {
                    maskAllInputs: true,
                    maskTextSelector: "[data-mask]",
                },
            });
        }

        function initCookieConsent() {
            const banner = document.getElementById("cookie-consent");
            const acceptBtn = document.getElementById("cookie-accept");
            const declineBtn = document.getElementById("cookie-decline");
            const consent = localStorage.getItem(CONSENT_KEY);

            // Consent bereits erteilt -> PostHog laden
            if (consent === "granted") {
                loadPostHog();
                return;
            }

            // Consent bereits abgelehnt -> nichts tun
            if (consent === "denied") {
                return;
            }

            // Kein Consent -> Banner anzeigen
            banner?.classList.remove("hidden");

            acceptBtn?.addEventListener("click", function () {
                localStorage.setItem(CONSENT_KEY, "granted");
                banner?.classList.add("hidden");
                loadPostHog();
            });

            declineBtn?.addEventListener("click", function () {
                localStorage.setItem(CONSENT_KEY, "denied");
                banner?.classList.add("hidden");
            });
        }

        // Init on DOM ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initCookieConsent);
        } else {
            initCookieConsent();
        }

        // Support für Astro View Transitions
        document.addEventListener("astro:page-load", initCookieConsent);
    })();
</script>
