---
import Header from "../../../../components/Header.astro";
import Footer from "../../../../components/Footer.astro";
import CalendlyLoader from "../../../../components/CalendlyLoader.astro";
import Breadcrumb from "../../../../components/Breadcrumb.astro";
import HeadCommon from "../../../../components/HeadCommon.astro";
import PflegedienstListItem from "../../../../components/pflegedienste/PflegedienstListItem.astro";
import DirectoryCTA from "../../../../components/pflegedienste/DirectoryCTA.astro";
import RegionalPotential from "../../../../components/pflegedienste/RegionalPotential.astro";
import ScrollToTop from "../../../../components/pflegedienste/ScrollToTop.astro";
import BundeslandSelector from "../../../../components/pflegedienste/BundeslandSelector.astro";
import "../../../../styles/global.css";
import {
    staedte,
    getPflegedienstStadt,
    getBundeslandBySlug,
    type StadtData,
} from "../../../../data/pflegedienste";

export async function getStaticPaths() {
    return staedte.map((stadt) => ({
        params: {
            bundesland: stadt.bundeslandSlug,
            stadt: stadt.slug,
        },
        props: { stadt },
    }));
}

interface Props {
    stadt: StadtData;
}

const { stadt } = Astro.props;
const bundesland = getBundeslandBySlug(stadt.bundeslandSlug);

// Get all dienste in this city
const diensteInStadt = getPflegedienstStadt(stadt.bundeslandSlug, stadt.slug);

const siteUrl = "https://partner.decari.de";
const canonicalUrl = `${siteUrl}/pflegedienste/${stadt.bundeslandSlug}/${stadt.slug}/`;

const metaDescription = `${stadt.diensteCount} ambulante Pflegedienste in ${stadt.name}, ${stadt.bundesland}. Kontaktdaten, Adressen und Informationen im Überblick.`;

// JSON-LD BreadcrumbList
const breadcrumbSchema = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Startseite", item: siteUrl },
        {
            "@type": "ListItem",
            position: 2,
            name: "Pflegedienste",
            item: `${siteUrl}/pflegedienste/`,
        },
        {
            "@type": "ListItem",
            position: 3,
            name: stadt.bundesland,
            item: `${siteUrl}/pflegedienste/${stadt.bundeslandSlug}/`,
        },
        { "@type": "ListItem", position: 4, name: stadt.name },
    ],
};

// JSON-LD ItemList for dienste
const itemListSchema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: `Pflegedienste in ${stadt.name}`,
    numberOfItems: diensteInStadt.length,
    itemListElement: diensteInStadt.slice(0, 10).map((dienst, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: dienst.companyName,
        url: `${siteUrl}/pflegedienste/${dienst.bundeslandSlug}/${dienst.stadtSlug}/${dienst.slug}/`,
    })),
};
---

<!doctype html>
<html lang="de">
    <head>
        <HeadCommon
            title={`Pflegedienste in ${stadt.name} | ${stadt.diensteCount} Anbieter – Decari`}
            description={metaDescription}
            canonicalUrl={canonicalUrl}
        />

        <script
            type="application/ld+json"
            set:html={JSON.stringify(breadcrumbSchema)}
        />
        <script
            type="application/ld+json"
            set:html={JSON.stringify(itemListSchema)}
        />
    </head>
    <body class="font-sans text-gray-800 bg-gray-50 antialiased">
        <Header variant="blog-article" />

        <main class="py-8 md:py-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <Breadcrumb
                    items={[
                        { label: "Startseite", href: "/" },
                        { label: "Pflegedienste", href: "/pflegedienste/" },
                        {
                            label: stadt.bundesland,
                            href: `/pflegedienste/${stadt.bundeslandSlug}/`,
                        },
                        { label: stadt.name },
                    ]}
                />

                <!-- Header -->
                <header class="mb-8">
                    <div
                        class="flex items-center gap-2 text-sm text-teal font-medium mb-2"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                            ></path>
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        {stadt.bundesland}
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-navy mb-3">
                        Pflegedienste in {stadt.name}
                    </h1>
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full bg-teal/10 text-teal text-sm font-medium"
                    >
                        <svg
                            class="w-4 h-4 mr-1.5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                            ></path>
                        </svg>
                        {stadt.diensteCount}
                        {
                            stadt.diensteCount === 1
                                ? "Pflegedienst"
                                : "Pflegedienste"
                        }
                    </span>
                </header>

                <!-- Regional Potential -->
                <RegionalPotential
                    stadtName={stadt.name}
                    diensteCount={stadt.diensteCount}
                />

                <!-- Dienste List -->
                <section class="mt-8">
                    <h2 class="text-lg font-semibold text-navy mb-4">
                        Alle Pflegedienste in {stadt.name}
                    </h2>
                    <div class="grid gap-3">
                        {
                            diensteInStadt.map((dienst) => (
                                <PflegedienstListItem dienst={dienst} />
                            ))
                        }
                    </div>
                </section>

                <!-- CTA -->
                <div class="mt-10">
                    <DirectoryCTA />
                </div>

                <!-- Back Navigation -->
                <div
                    class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                >
                    <div class="flex flex-wrap gap-4">
                        <a
                            href={`/pflegedienste/${stadt.bundeslandSlug}/`}
                            class="text-teal font-medium hover:text-teal-light transition-colors"
                        >
                            &larr; Alle Städte in {stadt.bundesland}
                        </a>
                        <a
                            href="/pflegedienste/"
                            class="text-gray-500 hover:text-teal transition-colors"
                        >
                            Alle Bundesländer
                        </a>
                    </div>
                    <div class="sm:w-48">
                        <BundeslandSelector
                            currentSlug={stadt.bundeslandSlug}
                        />
                    </div>
                </div>
            </div>
        </main>

        <Footer />

        <ScrollToTop />
        <CalendlyLoader />
    </body>
</html>
