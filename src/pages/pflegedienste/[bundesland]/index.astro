---
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import CalendlyLoader from "../../../components/CalendlyLoader.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import HeadCommon from "../../../components/HeadCommon.astro";
import CityCard from "../../../components/pflegedienste/CityCard.astro";
import DirectoryCTA from "../../../components/pflegedienste/DirectoryCTA.astro";
import "../../../styles/global.css";
import {
    bundeslaender,
    getStaedteByBundesland,
    type BundeslandData,
} from "../../../data/pflegedienste";
import {
    calculateRegionalPotential,
    formatCurrency,
} from "../../../utils/potentialCalculator";

export async function getStaticPaths() {
    return bundeslaender.map((bl) => ({
        params: { bundesland: bl.slug },
        props: { bundesland: bl },
    }));
}

interface Props {
    bundesland: BundeslandData;
}

const { bundesland } = Astro.props;

// Get all cities in this state, sorted by dienste count
const staedteInBundesland = getStaedteByBundesland(bundesland.slug).sort(
    (a, b) => b.diensteCount - a.diensteCount,
);

// Calculate regional potential
const potential = calculateRegionalPotential(
    bundesland.name,
    bundesland.diensteCount,
);

const siteUrl = "https://partner.decari.de";
const canonicalUrl = `${siteUrl}/pflegedienste/${bundesland.slug}/`;

const metaDescription = `${bundesland.diensteCount} ambulante Pflegedienste in ${bundesland.name}. Finden Sie Pflegedienste in ${bundesland.staedteCount} Städten mit Kontaktdaten und Informationen.`;

// JSON-LD BreadcrumbList
const breadcrumbSchema = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Startseite", item: siteUrl },
        {
            "@type": "ListItem",
            position: 2,
            name: "Pflegedienste",
            item: `${siteUrl}/pflegedienste/`,
        },
        { "@type": "ListItem", position: 3, name: bundesland.name },
    ],
};
---

<!doctype html>
<html lang="de">
    <head>
        <HeadCommon
            title={`Pflegedienste in ${bundesland.name} | ${bundesland.diensteCount} Anbieter – Decari`}
            description={metaDescription}
            canonicalUrl={canonicalUrl}
        />

        <script
            type="application/ld+json"
            set:html={JSON.stringify(breadcrumbSchema)}
        />
    </head>
    <body class="font-sans text-gray-800 bg-gray-50 antialiased">
        <Header variant="blog-article" />

        <main class="py-8 md:py-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <Breadcrumb
                    items={[
                        { label: "Startseite", href: "/" },
                        { label: "Pflegedienste", href: "/pflegedienste/" },
                        { label: bundesland.name },
                    ]}
                />

                <!-- Header -->
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-navy mb-3">
                        Pflegedienste in {bundesland.name}
                    </h1>
                    <p class="text-lg text-gray-600">
                        {bundesland.diensteCount.toLocaleString("de-DE")} ambulante
                        Pflegedienste in {
                            bundesland.staedteCount.toLocaleString("de-DE")
                        } Städten
                    </p>
                </header>

                <!-- Regional Potential Card -->
                <section
                    class="bg-gradient-to-br from-teal/5 to-teal/10 rounded-2xl p-6 md:p-8 border border-teal/20 mb-8"
                >
                    <div class="flex items-start gap-4 mb-4">
                        <div
                            class="flex-shrink-0 w-12 h-12 bg-teal/20 rounded-xl flex items-center justify-center"
                        >
                            <svg
                                class="w-6 h-6 text-teal"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-navy">
                                Ungenutztes Potenzial in {bundesland.name}
                            </h2>
                            <p class="text-gray-600 mt-1">
                                Geschätzte Sozialleistungen, die jährlich nicht
                                abgerufen werden
                            </p>
                        </div>
                    </div>
                    <p class="text-3xl md:text-4xl font-bold text-teal">
                        {formatCurrency(potential.yearlyPotential)}
                    </p>
                    <p class="text-sm text-gray-500 mt-2">
                        * Basierend auf Durchschnittswerten für ambulante
                        Pflegedienste
                    </p>
                </section>

                <!-- Cities Grid -->
                <section>
                    <h2 class="text-lg font-semibold text-navy mb-4">
                        Städte in {bundesland.name}
                    </h2>
                    <div class="grid gap-3 sm:grid-cols-2">
                        {
                            staedteInBundesland.map((stadt) => (
                                <CityCard stadt={stadt} />
                            ))
                        }
                    </div>
                </section>

                <!-- CTA -->
                <div class="mt-10">
                    <DirectoryCTA />
                </div>

                <!-- Back Navigation -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <a
                        href="/pflegedienste/"
                        class="text-teal font-medium hover:text-teal-light transition-colors"
                    >
                        &larr; Alle Bundesländer
                    </a>
                </div>
            </div>
        </main>

        <Footer />

        <CalendlyLoader />
    </body>
</html>
