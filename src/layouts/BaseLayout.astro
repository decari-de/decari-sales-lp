---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import CookieConsent from "../components/layout/CookieConsent.astro";
import "../styles/global.css";

interface Props {
    title: string;
    description?: string;
    canonicalUrl?: string;
    ogImage?: string;
}

const {
    title,
    description = "Decari beantragt für Ihre Klienten zusätzliche Sozialleistungen. Bis zu +3.000€/Monat pro Klient mit Zusatzanspruch – für effizientere Teams.",
    canonicalUrl,
    ogImage = "/assets/decari-logo.png",
} = Astro.props;

const siteUrl = "https://partner.decari.de";
const base = import.meta.env.BASE_URL;

// Generate canonical URL automatically if not provided
const currentUrl = new URL(Astro.url.pathname, siteUrl).href;
const finalCanonicalUrl = canonicalUrl || currentUrl;
---

<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title}</title>
        <meta name="description" content={description} />

        <!-- Open Graph / Social -->
        <meta property="og:type" content="website" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:url" content={finalCanonicalUrl} />
        <meta property="og:locale" content="de_DE" />
        <meta property="og:image" content={`${siteUrl}${ogImage}`} />

        <!-- Twitter Cards -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={`${siteUrl}${ogImage}`} />

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/png"
            href={`${base}assets/decari-favicon.png`}
        />
        <link
            rel="apple-touch-icon"
            href={`${base}assets/decari-favicon.png`}
        />

        <!-- Canonical -->
        <link rel="canonical" href={finalCanonicalUrl} />

        <!-- Preconnect for Performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <!-- Preload critical font -->
        <link
            rel="preload"
            href="https://fonts.gstatic.com/s/inter/v20/UcC73FwrK3iLTeHuS_nVMrMxCp50SjIa1ZL7W0Q5nw.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />

        <!-- Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <!-- Calendly CSS - loaded async -->
        <link
            rel="preload"
            href="https://assets.calendly.com/assets/external/widget.css"
            as="style"
            onload="this.onload=null;this.rel='stylesheet'"
        />
        <noscript>
            <link
                rel="stylesheet"
                href="https://assets.calendly.com/assets/external/widget.css"
            />
        </noscript>

        <!-- Structured Data -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": "ProfessionalService",
                name: "Decari GmbH",
                description:
                    "Sozialleistungs-Service für Pflegedienste. Wir beantragen zusätzliche Sozialleistungen für Ihre Klienten.",
                url: "https://partner.decari.de",
                email: "steffen@decari.de",
                serviceType: "Sozialleistungs-Service",
                areaServed: "DE",
            })}
        />
    </head>
    <body class="font-sans text-gray-800 bg-white antialiased">
        <!-- Skip to Content (Accessibility) -->
        <a
            href="#main-content"
            class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-teal text-white px-4 py-2 rounded-lg z-50"
        >
            Zum Hauptinhalt springen
        </a>

        <Header />

        <main id="main-content">
            <slot />
        </main>

        <Footer />

        <CookieConsent />

        <!-- Calendly Widget - lazy loaded -->
        <script is:inline>
            let calendlyLoaded = false;
            function loadCalendly() {
                if (calendlyLoaded) return;
                calendlyLoaded = true;
                const script = document.createElement("script");
                script.src =
                    "https://assets.calendly.com/assets/external/widget.js";
                script.async = true;
                document.body.appendChild(script);
            }

            ["scroll", "mousemove", "touchstart", "click"].forEach((event) => {
                document.addEventListener(event, loadCalendly, {
                    once: true,
                    passive: true,
                });
            });

            setTimeout(loadCalendly, 1500);

            // Guard-Funktion um doppelte Popup-Öffnung zu verhindern
            window.openCalendlyPopup = (function () {
                let isOpening = false;
                return function () {
                    if (isOpening || typeof Calendly === "undefined") return;
                    isOpening = true;
                    Calendly.initPopupWidget({
                        url: "https://calendly.com/steffen-decari/erstgespraech?primary_color=097788",
                    });
                    setTimeout(function () {
                        isOpening = false;
                    }, 1000);
                };
            })();
        </script>
    </body>
</html>
